<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>多数据库 + LLM 管理系统</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 font-sans">

  <div class="container mx-auto p-6 max-w-6xl">
    <h1 class="text-3xl font-bold text-center mb-6 text-blue-600">多数据库 + LLM 管理系统</h1>

    <!-- 导航标签 -->
    <div class="flex space-x-2 mb-6">
      <button onclick="showTab('users')" class="tab-btn active px-4 py-2 rounded bg-blue-600 text-white">用户管理</button>
      <button onclick="showTab('newdb')" class="tab-btn px-4 py-2 rounded bg-gray-300 text-gray-700">新数据库</button>
      <button onclick="showTab('llm')" class="tab-btn px-4 py-2 rounded bg-gray-300 text-gray-700">AI 助手</button>
    </div>

    <!-- 用户管理标签页 -->
    <div id="users-tab" class="tab-content">
      <!-- 添加用户表单 -->
      <div class="bg-white p-6 rounded-lg shadow mb-6">
        <h2 class="text-xl font-semibold mb-4">添加新用户</h2>
        <form id="createForm" class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-gray-700">姓名</label>
            <input type="text" name="name" required
                   class="w-full border border-gray-300 rounded-md p-2 focus:outline-none focus:ring-2 focus:ring-blue-500"/>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700">邮箱</label>
            <input type="email" name="email" required
                   class="w-full border border-gray-300 rounded-md p-2 focus:outline-none focus:ring-2 focus:ring-blue-500"/>
          </div>
          <button type="submit"
                  class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition">
            添加用户
          </button>
        </form>
      </div>

      <!-- 用户列表 -->
      <div class="bg-white p-6 rounded-lg shadow mb-6">
        <h2 class="text-xl font-semibold mb-4">用户列表</h2>
        <div id="userList" class="space-y-3">
          <p class="text-gray-500">正在加载...</p>
        </div>
      </div>

      <!-- RDS 用户列表 -->
      <div class="bg-white p-6 rounded-lg shadow">
        <h2 class="text-xl font-semibold mb-4">RDS 只读数据库用户</h2>
        <div id="rdsUserList" class="space-y-3 text-sm text-gray-600">
          <p>加载中...</p>
        </div>
      </div>
    </div>

    <!-- 新数据库标签页 -->
    <div id="newdb-tab" class="tab-content hidden">
      <!-- 添加产品表单 -->
      <div class="bg-white p-6 rounded-lg shadow mb-6">
        <h2 class="text-xl font-semibold mb-4">添加新产品</h2>
        <form id="productForm" class="space-y-4">
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-700">产品名称</label>
              <input type="text" name="name" required
                     class="w-full border border-gray-300 rounded-md p-2 focus:outline-none focus:ring-2 focus:ring-blue-500"/>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700">分类</label>
              <input type="text" name="category"
                     class="w-full border border-gray-300 rounded-md p-2 focus:outline-none focus:ring-2 focus:ring-blue-500"/>
            </div>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700">描述</label>
            <textarea name="description" rows="3"
                      class="w-full border border-gray-300 rounded-md p-2 focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700">价格</label>
            <input type="number" name="price" step="0.01" required
                   class="w-full border border-gray-300 rounded-md p-2 focus:outline-none focus:ring-2 focus:ring-blue-500"/>
          </div>
          <button type="submit"
                  class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 transition">
            添加产品
          </button>
        </form>
      </div>

      <!-- 产品列表 -->
      <div class="bg-white p-6 rounded-lg shadow mb-6">
        <h2 class="text-xl font-semibold mb-4">产品列表</h2>
        <div id="productList" class="space-y-3">
          <p class="text-gray-500">正在加载...</p>
        </div>
      </div>

      <!-- 添加订单表单 -->
      <div class="bg-white p-6 rounded-lg shadow mb-6">
        <h2 class="text-xl font-semibold mb-4">添加新订单</h2>
        <form id="orderForm" class="space-y-4">
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-700">客户姓名</label>
              <input type="text" name="customer_name" required
                     class="w-full border border-gray-300 rounded-md p-2 focus:outline-none focus:ring-2 focus:ring-blue-500"/>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700">产品ID</label>
              <input type="number" name="product_id" required
                     class="w-full border border-gray-300 rounded-md p-2 focus:outline-none focus:ring-2 focus:ring-blue-500"/>
            </div>
          </div>
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-700">数量</label>
              <input type="number" name="quantity" required
                     class="w-full border border-gray-300 rounded-md p-2 focus:outline-none focus:ring-2 focus:ring-blue-500"/>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700">总金额</label>
              <input type="number" name="total_amount" step="0.01" required
                     class="w-full border border-gray-300 rounded-md p-2 focus:outline-none focus:ring-2 focus:ring-blue-500"/>
            </div>
          </div>
          <button type="submit"
                  class="bg-purple-600 text-white px-4 py-2 rounded hover:bg-purple-700 transition">
            添加订单
          </button>
        </form>
      </div>

      <!-- 订单列表 -->
      <div class="bg-white p-6 rounded-lg shadow">
        <h2 class="text-xl font-semibold mb-4">订单列表</h2>
        <div id="orderList" class="space-y-3">
          <p class="text-gray-500">正在加载...</p>
        </div>
      </div>
    </div>

    <!-- AI 助手标签页 -->
    <div id="llm-tab" class="tab-content hidden">
      <div class="bg-white p-6 rounded-lg shadow">
        <h2 class="text-xl font-semibold mb-4">AI 智能助手</h2>
        
        <!-- 提示类型选择 -->
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-2">选择对话类型</label>
          <select id="promptType" class="w-full border border-gray-300 rounded-md p-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
            <option value="general">通用问答</option>
            <option value="product_analysis">产品分析</option>
            <option value="business_advice">商业建议</option>
          </select>
        </div>

        <!-- 聊天界面 -->
        <div class="space-y-4">
          <div id="chatHistory" class="h-96 overflow-y-auto border border-gray-300 rounded-md p-4 bg-gray-50">
            <p class="text-gray-500 text-center">开始与AI助手对话吧！</p>
          </div>
          
          <div class="flex space-x-2">
            <input type="text" id="chatInput" placeholder="输入您的问题..." 
                   class="flex-1 border border-gray-300 rounded-md p-2 focus:outline-none focus:ring-2 focus:ring-blue-500"/>
            <button onclick="sendMessage()" 
                    class="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700 transition">
              发送
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // 标签页切换
    function showTab(tabName) {
      // 隐藏所有标签页
      document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.add('hidden');
      });
      
      // 显示选中的标签页
      document.getElementById(tabName + '-tab').classList.remove('hidden');
      
      // 更新按钮状态
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('bg-blue-600', 'text-white');
        btn.classList.add('bg-gray-300', 'text-gray-700');
      });
      
      event.target.classList.remove('bg-gray-300', 'text-gray-700');
      event.target.classList.add('bg-blue-600', 'text-white');
      
      // 加载对应数据
      if (tabName === 'users') {
        loadUsers();
        loadRDSUsers();
      } else if (tabName === 'newdb') {
        loadProducts();
        loadOrders();
      }
    }

    // ✅ 获取所有用户
    async function loadUsers() {
        try {
        const res = await fetch('/users');
        if (!res.ok) {
            throw new Error(`HTTP ${res.status}: ${res.statusText}`);
        }
        const text = await res.text();
        console.log('Raw response:', text);
        const users = JSON.parse(text);
        const list = document.getElementById('userList');
        if (users.length === 0) {
            list.innerHTML = '<p class="text-gray-500">暂无用户</p>';
            return;
        }
        list.innerHTML = users.map(u => `
            <div class="border-b pb-2">
            <strong>${u.name}</strong> &lt;${u.email}&gt;
            <span class="text-sm text-gray-500 ml-2">(${u.created_at})</span>
            </div>
        `).join('');
        } catch (err) {
        console.error("加载用户失败:", err);
        document.getElementById('userList').innerHTML = '<p class="text-red-500">加载失败: ' + err.message + '</p>';
        }
    }

    // ✅ 添加用户
    document.getElementById('createForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        const data = Object.fromEntries(formData);

        try {
        const res = await fetch('/users', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });

        if (res.ok) {
            e.target.reset();
            await loadUsers();
        } else {
            const error = await res.json();
            alert("添加失败: " + error.detail);
        }
        } catch (err) {
        console.error("请求失败:", err);
        alert("网络错误");
        }
    });

    // ✅ 加载 RDS 用户
    async function loadRDSUsers() {
        try {
        const res = await fetch('/rds/users');
        if (!res.ok) {
            throw new Error(`HTTP ${res.status}: ${res.statusText}`);
        }
        const text = await res.text();
        console.log('RDS Raw response:', text);
        const data = JSON.parse(text);
        const list = document.getElementById('rdsUserList');
        
        if (data.data.length === 0) {
            list.innerHTML = '<p class="text-gray-500">RDS 中暂无用户</p>';
            return;
        }

        list.innerHTML = data.data.map(u => `
            <div class="border-b pb-2">
            🔹 <strong>${u.id || '未知'}</strong> 
            &lt;${u.content || '无邮箱'}&gt;
            <span class="text-xs text-gray-400">(${u.message_time})</span>
            </div>
        `).join('');
        } catch (err) {
        console.error("加载 RDS 用户失败:", err);
        document.getElementById('rdsUserList').innerHTML = 
            '<p class="text-red-500">连接失败: ' + err.message + '</p>';
        }
    }

    // 加载产品
    async function loadProducts() {
        try {
            const res = await fetch('/newdb/products');
            const products = await res.json();
            const list = document.getElementById('productList');
            
            if (products.length === 0) {
                list.innerHTML = '<p class="text-gray-500">暂无产品</p>';
                return;
            }
            
            list.innerHTML = products.map(p => `
                <div class="border-b pb-2">
                    <strong>${p.name}</strong> - ¥${p.price}
                    <span class="text-sm text-gray-500 ml-2">${p.category || '未分类'}</span>
                    <div class="text-xs text-gray-400">${p.description || '无描述'}</div>
                    <span class="text-xs text-gray-400">(${p.created_at})</span>
                </div>
            `).join('');
        } catch (err) {
            console.error("加载产品失败:", err);
            document.getElementById('productList').innerHTML = '<p class="text-red-500">加载失败</p>';
        }
    }

    // 添加产品
    document.getElementById('productForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        const data = Object.fromEntries(formData);
        data.price = parseFloat(data.price);

        try {
            const res = await fetch('/newdb/products', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            if (res.ok) {
                e.target.reset();
                await loadProducts();
                alert('产品添加成功！');
            } else {
                const error = await res.json();
                alert("添加失败: " + error.detail);
            }
        } catch (err) {
            console.error("请求失败:", err);
            alert("网络错误");
        }
    });

    // 加载订单
    async function loadOrders() {
        try {
            const res = await fetch('/newdb/orders');
            const orders = await res.json();
            const list = document.getElementById('orderList');
            
            if (orders.length === 0) {
                list.innerHTML = '<p class="text-gray-500">暂无订单</p>';
                return;
            }
            
            list.innerHTML = orders.map(o => `
                <div class="border-b pb-2">
                    <strong>${o.customer_name}</strong> - 数量: ${o.quantity} - ¥${o.total_amount}
                    <span class="text-sm text-gray-500 ml-2">产品ID: ${o.product_id}</span>
                    <span class="text-xs text-gray-400">(${o.order_date})</span>
                </div>
            `).join('');
        } catch (err) {
            console.error("加载订单失败:", err);
            document.getElementById('orderList').innerHTML = '<p class="text-red-500">加载失败</p>';
        }
    }

    // 添加订单
    document.getElementById('orderForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        const data = Object.fromEntries(formData);
        data.product_id = parseInt(data.product_id);
        data.quantity = parseInt(data.quantity);
        data.total_amount = parseFloat(data.total_amount);

        try {
            const res = await fetch('/newdb/orders', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            if (res.ok) {
                e.target.reset();
                await loadOrders();
                alert('订单添加成功！');
            } else {
                const error = await res.json();
                alert("添加失败: " + error.detail);
            }
        } catch (err) {
            console.error("请求失败:", err);
            alert("网络错误");
        }
    });

    // 发送聊天消息
    async function sendMessage() {
        const input = document.getElementById('chatInput');
        const message = input.value.trim();
        const promptType = document.getElementById('promptType').value;
        
        if (!message) return;
        
        // 添加用户消息到聊天历史
        addChatMessage('user', message);
        input.value = '';
        
        try {
            const res = await fetch('/llm/chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ message, prompt_type: promptType })
            });
            
            if (res.ok) {
                const data = await res.json();
                addChatMessage('assistant', data.response);
            } else {
                const error = await res.json();
                addChatMessage('assistant', `错误: ${error.detail}`);
            }
        } catch (err) {
            addChatMessage('assistant', '网络错误，请稍后重试');
        }
    }

    // 添加聊天消息到历史记录
    function addChatMessage(role, content) {
        const history = document.getElementById('chatHistory');
        const messageDiv = document.createElement('div');
        messageDiv.className = `mb-3 p-3 rounded-lg ${role === 'user' ? 'bg-blue-100 ml-8' : 'bg-green-100 mr-8'}`;
        messageDiv.innerHTML = `
            <div class="font-semibold text-sm mb-1">${role === 'user' ? '您' : 'AI助手'}</div>
            <div>${content}</div>
        `;
        history.appendChild(messageDiv);
        history.scrollTop = history.scrollHeight;
    }

    // 回车发送消息
    document.getElementById('chatInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            sendMessage();
        }
    });
    
    // 页面加载时获取用户数据
    loadUsers();
    loadRDSUsers();
  </script>
</body>
</html>
