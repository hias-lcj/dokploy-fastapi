<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>å¤šæ•°æ®åº“ + LLM ç®¡ç†ç³»ç»Ÿ</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 font-sans">

  <div class="container mx-auto p-6 max-w-6xl">
    <h1 class="text-3xl font-bold text-center mb-6 text-blue-600">å¤šæ•°æ®åº“ + LLM ç®¡ç†ç³»ç»Ÿ</h1>

    <!-- å¯¼èˆªæ ‡ç­¾ -->
    <div class="flex space-x-2 mb-6">
      <button onclick="showTab('users')" class="tab-btn active px-4 py-2 rounded bg-blue-600 text-white">ç”¨æˆ·ç®¡ç†</button>
      <button onclick="showTab('newdb')" class="tab-btn px-4 py-2 rounded bg-gray-300 text-gray-700">æ–°æ•°æ®åº“</button>
      <button onclick="showTab('llm')" class="tab-btn px-4 py-2 rounded bg-gray-300 text-gray-700">AI åŠ©æ‰‹</button>
    </div>

    <!-- ç”¨æˆ·ç®¡ç†æ ‡ç­¾é¡µ -->
    <div id="users-tab" class="tab-content">
      <!-- æ·»åŠ ç”¨æˆ·è¡¨å• -->
      <div class="bg-white p-6 rounded-lg shadow mb-6">
        <h2 class="text-xl font-semibold mb-4">æ·»åŠ æ–°ç”¨æˆ·</h2>
        <form id="createForm" class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-gray-700">å§“å</label>
            <input type="text" name="name" required
                   class="w-full border border-gray-300 rounded-md p-2 focus:outline-none focus:ring-2 focus:ring-blue-500"/>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700">é‚®ç®±</label>
            <input type="email" name="email" required
                   class="w-full border border-gray-300 rounded-md p-2 focus:outline-none focus:ring-2 focus:ring-blue-500"/>
          </div>
          <button type="submit"
                  class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition">
            æ·»åŠ ç”¨æˆ·
          </button>
        </form>
      </div>

      <!-- ç”¨æˆ·åˆ—è¡¨ -->
      <div class="bg-white p-6 rounded-lg shadow mb-6">
        <h2 class="text-xl font-semibold mb-4">ç”¨æˆ·åˆ—è¡¨</h2>
        <div id="userList" class="space-y-3">
          <p class="text-gray-500">æ­£åœ¨åŠ è½½...</p>
        </div>
      </div>

      <!-- RDS ç”¨æˆ·åˆ—è¡¨ -->
      <div class="bg-white p-6 rounded-lg shadow">
        <h2 class="text-xl font-semibold mb-4">RDS åªè¯»æ•°æ®åº“ç”¨æˆ·</h2>
        <div id="rdsUserList" class="space-y-3 text-sm text-gray-600">
          <p>åŠ è½½ä¸­...</p>
        </div>
      </div>
    </div>

    <!-- æ–°æ•°æ®åº“æ ‡ç­¾é¡µ -->
    <div id="newdb-tab" class="tab-content hidden">
      <!-- æ·»åŠ äº§å“è¡¨å• -->
      <div class="bg-white p-6 rounded-lg shadow mb-6">
        <h2 class="text-xl font-semibold mb-4">æ·»åŠ æ–°äº§å“</h2>
        <form id="productForm" class="space-y-4">
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-700">äº§å“åç§°</label>
              <input type="text" name="name" required
                     class="w-full border border-gray-300 rounded-md p-2 focus:outline-none focus:ring-2 focus:ring-blue-500"/>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700">åˆ†ç±»</label>
              <input type="text" name="category"
                     class="w-full border border-gray-300 rounded-md p-2 focus:outline-none focus:ring-2 focus:ring-blue-500"/>
            </div>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700">æè¿°</label>
            <textarea name="description" rows="3"
                      class="w-full border border-gray-300 rounded-md p-2 focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700">ä»·æ ¼</label>
            <input type="number" name="price" step="0.01" required
                   class="w-full border border-gray-300 rounded-md p-2 focus:outline-none focus:ring-2 focus:ring-blue-500"/>
          </div>
          <button type="submit"
                  class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 transition">
            æ·»åŠ äº§å“
          </button>
        </form>
      </div>

      <!-- äº§å“åˆ—è¡¨ -->
      <div class="bg-white p-6 rounded-lg shadow mb-6">
        <h2 class="text-xl font-semibold mb-4">äº§å“åˆ—è¡¨</h2>
        <div id="productList" class="space-y-3">
          <p class="text-gray-500">æ­£åœ¨åŠ è½½...</p>
        </div>
      </div>

      <!-- æ·»åŠ è®¢å•è¡¨å• -->
      <div class="bg-white p-6 rounded-lg shadow mb-6">
        <h2 class="text-xl font-semibold mb-4">æ·»åŠ æ–°è®¢å•</h2>
        <form id="orderForm" class="space-y-4">
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-700">å®¢æˆ·å§“å</label>
              <input type="text" name="customer_name" required
                     class="w-full border border-gray-300 rounded-md p-2 focus:outline-none focus:ring-2 focus:ring-blue-500"/>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700">äº§å“ID</label>
              <input type="number" name="product_id" required
                     class="w-full border border-gray-300 rounded-md p-2 focus:outline-none focus:ring-2 focus:ring-blue-500"/>
            </div>
          </div>
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-700">æ•°é‡</label>
              <input type="number" name="quantity" required
                     class="w-full border border-gray-300 rounded-md p-2 focus:outline-none focus:ring-2 focus:ring-blue-500"/>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700">æ€»é‡‘é¢</label>
              <input type="number" name="total_amount" step="0.01" required
                     class="w-full border border-gray-300 rounded-md p-2 focus:outline-none focus:ring-2 focus:ring-blue-500"/>
            </div>
          </div>
          <button type="submit"
                  class="bg-purple-600 text-white px-4 py-2 rounded hover:bg-purple-700 transition">
            æ·»åŠ è®¢å•
          </button>
        </form>
      </div>

      <!-- è®¢å•åˆ—è¡¨ -->
      <div class="bg-white p-6 rounded-lg shadow">
        <h2 class="text-xl font-semibold mb-4">è®¢å•åˆ—è¡¨</h2>
        <div id="orderList" class="space-y-3">
          <p class="text-gray-500">æ­£åœ¨åŠ è½½...</p>
        </div>
      </div>
    </div>

    <!-- AI åŠ©æ‰‹æ ‡ç­¾é¡µ -->
    <div id="llm-tab" class="tab-content hidden">
      <div class="bg-white p-6 rounded-lg shadow">
        <h2 class="text-xl font-semibold mb-4">AI æ™ºèƒ½åŠ©æ‰‹</h2>
        
        <!-- æç¤ºç±»å‹é€‰æ‹© -->
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-2">é€‰æ‹©å¯¹è¯ç±»å‹</label>
          <select id="promptType" class="w-full border border-gray-300 rounded-md p-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
            <option value="general">é€šç”¨é—®ç­”</option>
            <option value="product_analysis">äº§å“åˆ†æ</option>
            <option value="business_advice">å•†ä¸šå»ºè®®</option>
          </select>
        </div>

        <!-- èŠå¤©ç•Œé¢ -->
        <div class="space-y-4">
          <div id="chatHistory" class="h-96 overflow-y-auto border border-gray-300 rounded-md p-4 bg-gray-50">
            <p class="text-gray-500 text-center">å¼€å§‹ä¸AIåŠ©æ‰‹å¯¹è¯å§ï¼</p>
          </div>
          
          <div class="flex space-x-2">
            <input type="text" id="chatInput" placeholder="è¾“å…¥æ‚¨çš„é—®é¢˜..." 
                   class="flex-1 border border-gray-300 rounded-md p-2 focus:outline-none focus:ring-2 focus:ring-blue-500"/>
            <button onclick="sendMessage()" 
                    class="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700 transition">
              å‘é€
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // æ ‡ç­¾é¡µåˆ‡æ¢
    function showTab(tabName) {
      // éšè—æ‰€æœ‰æ ‡ç­¾é¡µ
      document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.add('hidden');
      });
      
      // æ˜¾ç¤ºé€‰ä¸­çš„æ ‡ç­¾é¡µ
      document.getElementById(tabName + '-tab').classList.remove('hidden');
      
      // æ›´æ–°æŒ‰é’®çŠ¶æ€
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('bg-blue-600', 'text-white');
        btn.classList.add('bg-gray-300', 'text-gray-700');
      });
      
      event.target.classList.remove('bg-gray-300', 'text-gray-700');
      event.target.classList.add('bg-blue-600', 'text-white');
      
      // åŠ è½½å¯¹åº”æ•°æ®
      if (tabName === 'users') {
        loadUsers();
        loadRDSUsers();
      } else if (tabName === 'newdb') {
        loadProducts();
        loadOrders();
      }
    }

    // âœ… è·å–æ‰€æœ‰ç”¨æˆ·
    async function loadUsers() {
        try {
        const res = await fetch('/users');
        if (!res.ok) {
            throw new Error(`HTTP ${res.status}: ${res.statusText}`);
        }
        const text = await res.text();
        console.log('Raw response:', text);
        const users = JSON.parse(text);
        const list = document.getElementById('userList');
        if (users.length === 0) {
            list.innerHTML = '<p class="text-gray-500">æš‚æ— ç”¨æˆ·</p>';
            return;
        }
        list.innerHTML = users.map(u => `
            <div class="border-b pb-2">
            <strong>${u.name}</strong> &lt;${u.email}&gt;
            <span class="text-sm text-gray-500 ml-2">(${u.created_at})</span>
            </div>
        `).join('');
        } catch (err) {
        console.error("åŠ è½½ç”¨æˆ·å¤±è´¥:", err);
        document.getElementById('userList').innerHTML = '<p class="text-red-500">åŠ è½½å¤±è´¥: ' + err.message + '</p>';
        }
    }

    // âœ… æ·»åŠ ç”¨æˆ·
    document.getElementById('createForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        const data = Object.fromEntries(formData);

        try {
        const res = await fetch('/users', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });

        if (res.ok) {
            e.target.reset();
            await loadUsers();
        } else {
            const error = await res.json();
            alert("æ·»åŠ å¤±è´¥: " + error.detail);
        }
        } catch (err) {
        console.error("è¯·æ±‚å¤±è´¥:", err);
        alert("ç½‘ç»œé”™è¯¯");
        }
    });

    // âœ… åŠ è½½ RDS ç”¨æˆ·
    async function loadRDSUsers() {
        try {
        const res = await fetch('/rds/users');
        if (!res.ok) {
            throw new Error(`HTTP ${res.status}: ${res.statusText}`);
        }
        const text = await res.text();
        console.log('RDS Raw response:', text);
        const data = JSON.parse(text);
        const list = document.getElementById('rdsUserList');
        
        if (data.data.length === 0) {
            list.innerHTML = '<p class="text-gray-500">RDS ä¸­æš‚æ— ç”¨æˆ·</p>';
            return;
        }

        list.innerHTML = data.data.map(u => `
            <div class="border-b pb-2">
            ğŸ”¹ <strong>${u.id || 'æœªçŸ¥'}</strong> 
            &lt;${u.content || 'æ— é‚®ç®±'}&gt;
            <span class="text-xs text-gray-400">(${u.message_time})</span>
            </div>
        `).join('');
        } catch (err) {
        console.error("åŠ è½½ RDS ç”¨æˆ·å¤±è´¥:", err);
        document.getElementById('rdsUserList').innerHTML = 
            '<p class="text-red-500">è¿æ¥å¤±è´¥: ' + err.message + '</p>';
        }
    }

    // åŠ è½½äº§å“
    async function loadProducts() {
        try {
            const res = await fetch('/newdb/products');
            const products = await res.json();
            const list = document.getElementById('productList');
            
            if (products.length === 0) {
                list.innerHTML = '<p class="text-gray-500">æš‚æ— äº§å“</p>';
                return;
            }
            
            list.innerHTML = products.map(p => `
                <div class="border-b pb-2">
                    <strong>${p.name}</strong> - Â¥${p.price}
                    <span class="text-sm text-gray-500 ml-2">${p.category || 'æœªåˆ†ç±»'}</span>
                    <div class="text-xs text-gray-400">${p.description || 'æ— æè¿°'}</div>
                    <span class="text-xs text-gray-400">(${p.created_at})</span>
                </div>
            `).join('');
        } catch (err) {
            console.error("åŠ è½½äº§å“å¤±è´¥:", err);
            document.getElementById('productList').innerHTML = '<p class="text-red-500">åŠ è½½å¤±è´¥</p>';
        }
    }

    // æ·»åŠ äº§å“
    document.getElementById('productForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        const data = Object.fromEntries(formData);
        data.price = parseFloat(data.price);

        try {
            const res = await fetch('/newdb/products', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            if (res.ok) {
                e.target.reset();
                await loadProducts();
                alert('äº§å“æ·»åŠ æˆåŠŸï¼');
            } else {
                const error = await res.json();
                alert("æ·»åŠ å¤±è´¥: " + error.detail);
            }
        } catch (err) {
            console.error("è¯·æ±‚å¤±è´¥:", err);
            alert("ç½‘ç»œé”™è¯¯");
        }
    });

    // åŠ è½½è®¢å•
    async function loadOrders() {
        try {
            const res = await fetch('/newdb/orders');
            const orders = await res.json();
            const list = document.getElementById('orderList');
            
            if (orders.length === 0) {
                list.innerHTML = '<p class="text-gray-500">æš‚æ— è®¢å•</p>';
                return;
            }
            
            list.innerHTML = orders.map(o => `
                <div class="border-b pb-2">
                    <strong>${o.customer_name}</strong> - æ•°é‡: ${o.quantity} - Â¥${o.total_amount}
                    <span class="text-sm text-gray-500 ml-2">äº§å“ID: ${o.product_id}</span>
                    <span class="text-xs text-gray-400">(${o.order_date})</span>
                </div>
            `).join('');
        } catch (err) {
            console.error("åŠ è½½è®¢å•å¤±è´¥:", err);
            document.getElementById('orderList').innerHTML = '<p class="text-red-500">åŠ è½½å¤±è´¥</p>';
        }
    }

    // æ·»åŠ è®¢å•
    document.getElementById('orderForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        const data = Object.fromEntries(formData);
        data.product_id = parseInt(data.product_id);
        data.quantity = parseInt(data.quantity);
        data.total_amount = parseFloat(data.total_amount);

        try {
            const res = await fetch('/newdb/orders', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            if (res.ok) {
                e.target.reset();
                await loadOrders();
                alert('è®¢å•æ·»åŠ æˆåŠŸï¼');
            } else {
                const error = await res.json();
                alert("æ·»åŠ å¤±è´¥: " + error.detail);
            }
        } catch (err) {
            console.error("è¯·æ±‚å¤±è´¥:", err);
            alert("ç½‘ç»œé”™è¯¯");
        }
    });

    // å‘é€èŠå¤©æ¶ˆæ¯
    async function sendMessage() {
        const input = document.getElementById('chatInput');
        const message = input.value.trim();
        const promptType = document.getElementById('promptType').value;
        
        if (!message) return;
        
        // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯åˆ°èŠå¤©å†å²
        addChatMessage('user', message);
        input.value = '';
        
        try {
            const res = await fetch('/llm/chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ message, prompt_type: promptType })
            });
            
            if (res.ok) {
                const data = await res.json();
                addChatMessage('assistant', data.response);
            } else {
                const error = await res.json();
                addChatMessage('assistant', `é”™è¯¯: ${error.detail}`);
            }
        } catch (err) {
            addChatMessage('assistant', 'ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•');
        }
    }

    // æ·»åŠ èŠå¤©æ¶ˆæ¯åˆ°å†å²è®°å½•
    function addChatMessage(role, content) {
        const history = document.getElementById('chatHistory');
        const messageDiv = document.createElement('div');
        messageDiv.className = `mb-3 p-3 rounded-lg ${role === 'user' ? 'bg-blue-100 ml-8' : 'bg-green-100 mr-8'}`;
        messageDiv.innerHTML = `
            <div class="font-semibold text-sm mb-1">${role === 'user' ? 'æ‚¨' : 'AIåŠ©æ‰‹'}</div>
            <div>${content}</div>
        `;
        history.appendChild(messageDiv);
        history.scrollTop = history.scrollHeight;
    }

    // å›è½¦å‘é€æ¶ˆæ¯
    document.getElementById('chatInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            sendMessage();
        }
    });
    
    // é¡µé¢åŠ è½½æ—¶è·å–ç”¨æˆ·æ•°æ®
    loadUsers();
    loadRDSUsers();
  </script>
</body>
</html>
